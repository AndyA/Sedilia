let buf = new Uint8Array(0);

async function processBinaryStream(stream) {
  for await (const chunk of stream) {
    // Append chunk to buffer
    const newBuf = new Uint8Array(buf.length + chunk.length);
    newBuf.set(buf);
    newBuf.set(chunk, buf.length);
    buf = newBuf;

    const result = Bun.JSONL.parseChunk(buf);

    for (const value of result.values) {
      xref3(value);
    }

    // Keep unconsumed bytes
    buf = buf.slice(result.read);
  }
}

function emit(key, value) {
  writer.write(JSON.stringify([key, value]) + "\n");
}

function xref3(doc) {
  // DO NOT EDIT
  // generated by /opt/genome/g3/app/lib/couchdb/view-builder.js

  const ref = {};

  emit([doc._id, 0, doc._id, doc.kind], null);

  const m = doc._id.match(/^availability_(.+)$/);
  if (m) ref[m[1]] = 0;

  const alias = doc.alias || [];
  for (var i = 0; i < alias.length; i++) {
    const ak = alias[i];
    emit([ak, -2, doc._id, doc.kind], null);
    emit([doc._id, 2, ak, 0], { _id: ak });
  }

  // ERD based prober
  if (doc.pips !== undefined) {
    if (doc.pips.alternate_images_for !== undefined) {
      if (doc.pips.alternate_images_for.alternate_image_for !== undefined) {
        var x1 = doc.pips.alternate_images_for.alternate_image_for;
        var x1l = x1.length;
        if (x1l) {
          for (var x1i = 0; x1i < x1l; x1i++) {
            var x1o = x1[x1i];
            if (x1o.image !== undefined) {
              if (x1o.image.pid !== undefined) {
                // $.pips.alternate_images_for.alternate_image_for[*].image.pid
                ref[x1o.image.pid] = 1;
              }
            }
            if (x1o.inherited_from !== undefined) {
              if (x1o.inherited_from.link !== undefined) {
                if (x1o.inherited_from.link.pid !== undefined) {
                  // $.pips.alternate_images_for.alternate_image_for[*].inherited_from.link.pid
                  ref[x1o.inherited_from.link.pid] = 2;
                }
              }
            }
          }
        }
      }
    }
    if (doc.pips.ancestor_hierarchy !== undefined) {
      if (doc.pips.ancestor_hierarchy.ancestors !== undefined) {
        if (doc.pips.ancestor_hierarchy.ancestors.ancestor !== undefined) {
          var x2 = doc.pips.ancestor_hierarchy.ancestors.ancestor;
          var x2l = x2.length;
          if (x2l) {
            for (var x2i = 0; x2i < x2l; x2i++) {
              var x2o = x2[x2i];
              if (x2o.pid !== undefined) {
                // $.pips.ancestor_hierarchy.ancestors.ancestor[*].pid
                ref[x2o.pid] = 3;
              }
            }
          }
        }
      }
    }
    if (doc.pips.broadcast !== undefined) {
      if (doc.pips.broadcast.broadcast_of !== undefined) {
        if (doc.pips.broadcast.broadcast_of.link !== undefined) {
          if (doc.pips.broadcast.broadcast_of.link.pid !== undefined) {
            // $.pips.broadcast.broadcast_of.link.pid
            ref[doc.pips.broadcast.broadcast_of.link.pid] = 4;
          }
        }
      }
    }
    if (doc.pips.clip !== undefined) {
      if (doc.pips.clip.clip_of !== undefined) {
        if (doc.pips.clip.clip_of.link !== undefined) {
          if (doc.pips.clip.clip_of.link.pid !== undefined) {
            // $.pips.clip.clip_of.link.pid
            ref[doc.pips.clip.clip_of.link.pid] = 5;
          }
        }
      }
    }
    if (doc.pips.contribution !== undefined) {
      if (doc.pips.contribution.contribution_by !== undefined) {
        if (doc.pips.contribution.contribution_by.link !== undefined) {
          if (doc.pips.contribution.contribution_by.link.pid !== undefined) {
            // $.pips.contribution.contribution_by.link.pid
            ref[doc.pips.contribution.contribution_by.link.pid] = 6;
          }
        }
      }
      if (doc.pips.contribution.contribution_to !== undefined) {
        if (doc.pips.contribution.contribution_to.link !== undefined) {
          if (doc.pips.contribution.contribution_to.link.pid !== undefined) {
            // $.pips.contribution.contribution_to.link.pid
            ref[doc.pips.contribution.contribution_to.link.pid] = 7;
          }
        }
      }
    }
    if (doc.pips.contributor !== undefined) {
      if (doc.pips.contributor.canonical_contributor !== undefined) {
        if (doc.pips.contributor.canonical_contributor.link !== undefined) {
          if (
            doc.pips.contributor.canonical_contributor.link.pid !== undefined
          ) {
            // $.pips.contributor.canonical_contributor.link.pid
            ref[doc.pips.contributor.canonical_contributor.link.pid] = 8;
          }
        }
      }
    }
    if (doc.pips.episode !== undefined) {
      if (doc.pips.episode.member_of !== undefined) {
        if (doc.pips.episode.member_of.link !== undefined) {
          if (doc.pips.episode.member_of.link.pid !== undefined) {
            // $.pips.episode.member_of.link.pid
            ref[doc.pips.episode.member_of.link.pid] = 9;
          }
        }
      }
    }
    if (doc.pips.format_hierarchy !== undefined) {
      if (doc.pips.format_hierarchy.programme_formats !== undefined) {
        var x3 = doc.pips.format_hierarchy.programme_formats;
        var x3l = x3.length;
        if (x3l) {
          for (var x3i = 0; x3i < x3l; x3i++) {
            var x3o = x3[x3i];
            if (x3o.inherited_from !== undefined) {
              if (x3o.inherited_from.link !== undefined) {
                if (x3o.inherited_from.link.pid !== undefined) {
                  // $.pips.format_hierarchy.programme_formats[*].inherited_from.link.pid
                  ref[x3o.inherited_from.link.pid] = 10;
                }
              }
            }
          }
        }
      }
    }
    if (doc.pips.genre_hierarchy !== undefined) {
      if (doc.pips.genre_hierarchy.genres !== undefined) {
        var x4 = doc.pips.genre_hierarchy.genres;
        var x4l = x4.length;
        if (x4l) {
          for (var x4i = 0; x4i < x4l; x4i++) {
            var x4o = x4[x4i];
            if (x4o.inherited_from !== undefined) {
              if (x4o.inherited_from.link !== undefined) {
                if (x4o.inherited_from.link.pid !== undefined) {
                  // $.pips.genre_hierarchy.genres[*].inherited_from.link.pid
                  ref[x4o.inherited_from.link.pid] = 11;
                }
              }
            }
          }
        }
      }
    }
    if (doc.pips.image_for !== undefined) {
      if (doc.pips.image_for.image !== undefined) {
        if (doc.pips.image_for.image.pid !== undefined) {
          // $.pips.image_for.image.pid
          ref[doc.pips.image_for.image.pid] = 12;
        }
      }
      if (doc.pips.image_for.inherited_from !== undefined) {
        if (doc.pips.image_for.inherited_from.link !== undefined) {
          if (doc.pips.image_for.inherited_from.link.pid !== undefined) {
            // $.pips.image_for.inherited_from.link.pid
            ref[doc.pips.image_for.inherited_from.link.pid] = 13;
          }
        }
      }
    }
    if (doc.pips.master_brand_for !== undefined) {
      if (doc.pips.master_brand_for.inherited_from !== undefined) {
        if (doc.pips.master_brand_for.inherited_from.link !== undefined) {
          if (doc.pips.master_brand_for.inherited_from.link.pid !== undefined) {
            // $.pips.master_brand_for.inherited_from.link.pid
            ref[doc.pips.master_brand_for.inherited_from.link.pid] = 14;
          }
        }
      }
    }
    if (doc.pips.membership !== undefined) {
      if (doc.pips.membership.group !== undefined) {
        if (doc.pips.membership.group.link !== undefined) {
          if (doc.pips.membership.group.link.pid !== undefined) {
            // $.pips.membership.group.link.pid
            ref[doc.pips.membership.group.link.pid] = 15;
          }
        }
      }
      if (doc.pips.membership.member !== undefined) {
        if (doc.pips.membership.member.link !== undefined) {
          if (doc.pips.membership.member.link.pid !== undefined) {
            // $.pips.membership.member.link.pid
            ref[doc.pips.membership.member.link.pid] = 16;
          }
        }
      }
    }
    if (doc.pips.series !== undefined) {
      if (doc.pips.series.member_of !== undefined) {
        if (doc.pips.series.member_of.link !== undefined) {
          if (doc.pips.series.member_of.link.pid !== undefined) {
            // $.pips.series.member_of.link.pid
            ref[doc.pips.series.member_of.link.pid] = 17;
          }
        }
      }
    }
    if (doc.pips.synopsis_hierarchy !== undefined) {
      if (doc.pips.synopsis_hierarchy.synopses !== undefined) {
        var x5 = doc.pips.synopsis_hierarchy.synopses;
        var x5l = x5.length;
        if (x5l) {
          for (var x5i = 0; x5i < x5l; x5i++) {
            var x5o = x5[x5i];
            if (x5o.inherited_from !== undefined) {
              if (x5o.inherited_from.link !== undefined) {
                if (x5o.inherited_from.link.pid !== undefined) {
                  // $.pips.synopsis_hierarchy.synopses[*].inherited_from.link.pid
                  ref[x5o.inherited_from.link.pid] = 18;
                }
              }
            }
          }
        }
      }
    }
    if (doc.pips.tagging !== undefined) {
      if (doc.pips.tagging.application_of !== undefined) {
        if (doc.pips.tagging.application_of.link !== undefined) {
          if (doc.pips.tagging.application_of.link.pid !== undefined) {
            // $.pips.tagging.application_of.link.pid
            ref[doc.pips.tagging.application_of.link.pid] = 20;
          }
        }
      }
      if (doc.pips.tagging.application_to !== undefined) {
        if (doc.pips.tagging.application_to.link !== undefined) {
          if (doc.pips.tagging.application_to.link.pid !== undefined) {
            // $.pips.tagging.application_to.link.pid
            ref[doc.pips.tagging.application_to.link.pid] = 21;
          }
        }
      }
    }
    if (doc.pips.title_hierarchy !== undefined) {
      if (doc.pips.title_hierarchy.titles !== undefined) {
        var x6 = doc.pips.title_hierarchy.titles;
        var x6l = x6.length;
        if (x6l) {
          for (var x6i = 0; x6i < x6l; x6i++) {
            var x6o = x6[x6i];
            if (x6o.inherited_from !== undefined) {
              if (x6o.inherited_from.link !== undefined) {
                if (x6o.inherited_from.link.pid !== undefined) {
                  // $.pips.title_hierarchy.titles[*].inherited_from.link.pid
                  ref[x6o.inherited_from.link.pid] = 22;
                }
              }
            }
          }
        }
      }
    }
    if (doc.pips.version !== undefined) {
      if (doc.pips.version.version_of !== undefined) {
        if (doc.pips.version.version_of.link !== undefined) {
          if (doc.pips.version.version_of.link.pid !== undefined) {
            // $.pips.version.version_of.link.pid
            ref[doc.pips.version.version_of.link.pid] = 23;
          }
        }
      }
    }
    if (doc.pips.window !== undefined) {
      if (doc.pips.window.publication_of !== undefined) {
        if (doc.pips.window.publication_of.link !== undefined) {
          if (doc.pips.window.publication_of.link.pid !== undefined) {
            // $.pips.window.publication_of.link.pid
            ref[doc.pips.window.publication_of.link.pid] = 24;
          }
        }
      }
    }
  }
  if (doc.programme_availability !== undefined) {
    if (doc.programme_availability.available_versions !== undefined) {
      if (
        doc.programme_availability.available_versions.available_version !==
        undefined
      ) {
        var x7 =
          doc.programme_availability.available_versions.available_version;
        var x7l = x7.length;
        if (x7l) {
          for (var x7i = 0; x7i < x7l; x7i++) {
            var x7o = x7[x7i];
            if (x7o.availabilities !== undefined) {
              if (x7o.availabilities.ondemand !== undefined) {
                var x8 = x7o.availabilities.ondemand;
                var x8l = x8.length;
                if (x8l) {
                  for (var x8i = 0; x8i < x8l; x8i++) {
                    var x8o = x8[x8i];
                    if (x8o.broadcast_of !== undefined) {
                      if (x8o.broadcast_of.link !== undefined) {
                        if (x8o.broadcast_of.link.pid !== undefined) {
                          // $.programme_availability.available_versions.available_version[*].availabilities.ondemand[*].broadcast_of.link.pid
                          ref[x8o.broadcast_of.link.pid] = 25;
                        }
                      }
                    }
                  }
                }
              }
            }
            if (x7o.version !== undefined) {
              if (x7o.version.pid !== undefined) {
                // $.programme_availability.available_versions.available_version[*].version.pid
                ref[x7o.version.pid] = 26;
              }
              if (x7o.version.version_of !== undefined) {
                if (x7o.version.version_of.link !== undefined) {
                  if (x7o.version.version_of.link.pid !== undefined) {
                    // $.programme_availability.available_versions.available_version[*].version.version_of.link.pid
                    ref[x7o.version.version_of.link.pid] = 27;
                  }
                }
              }
            }
          }
        }
      }
    }
    if (doc.programme_availability.pid !== undefined) {
      // $.programme_availability.pid
      ref[doc.programme_availability.pid] = 28;
    }
  }
  if (doc.rt !== undefined) {
    if (doc.rt.broadcast !== undefined) {
      if (doc.rt.broadcast.issue !== undefined) {
        // $.rt.broadcast.issue
        ref[doc.rt.broadcast.issue] = 29;
      }
      if (doc.rt.broadcast.listing !== undefined) {
        // $.rt.broadcast.listing
        ref[doc.rt.broadcast.listing] = 30;
      }
    }
    if (doc.rt.edit !== undefined) {
      if (doc.rt.edit.object !== undefined) {
        // $.rt.edit.object
        ref[doc.rt.edit.object] = 31;
      }
    }
    if (doc.rt.issue !== undefined) {
      if (doc.rt.issue._parent !== undefined) {
        // $.rt.issue._parent
        ref[doc.rt.issue._parent] = 33;
      }
    }
    if (doc.rt.listing !== undefined) {
      if (doc.rt.listing.issue !== undefined) {
        // $.rt.listing.issue
        ref[doc.rt.listing.issue] = 32;
      }
    }
  }

  const k = Object.keys(ref);
  for (var i = 0; i < k.length; i++) {
    const fk = k[i];
    emit([fk, -1, doc._id, doc.kind], null);
    emit([doc._id, 1, fk, ref[fk]], { _id: fk });
  }
}

const writer = Bun.stdout.writer();

await processBinaryStream(Bun.stdin.stream());
